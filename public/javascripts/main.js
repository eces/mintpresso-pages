// Generated by CoffeeScript 1.6.3
/*
Jinhyuk Lee at mintpresso.com
*/


(function() {
  if (String.prototype.format === void 0) {
    String.prototype.format = function() {
      var _arguments;
      _arguments = arguments;
      return this.replace(/{(\d+)}/g, function(match, number) {
        if (typeof _arguments[number] !== 'undefined') {
          return _arguments[number];
        } else {
          return match;
        }
      });
    };
  }

  String.prototype.endsWith = function(suffix) {
    return this.substr(this.length - suffix.length) === suffix;
  };

  String.prototype.startsWith = function(prefix) {
    return this.substr(0, prefix.length) === prefix;
  };

  String.prototype.capitalize = function(lower) {
    if (lower) {
      return this.toLowerCase();
    } else {
      return this.replace(/(?:^|\s)\S/g, function(a) {
        return a.toUpperCase();
      });
    }
  };

  jQuery(function() {
    var $body, $meta, content, event, pagesViewModel;
    $('input, textarea').placeholder();
    $body = $('body');
    event = {
      afterLoad: function() {
        var html, logo, support;
        logo = $('#animation-mask #logo');
        html = $('html');
        support = html.is('.csstransitions') && html.is('.opacity');
        if (_.doneLoading === true) {
          if (_.waitForLoading === true) {
            if (logo.is(':hidden')) {
              logo.fadeIn(1000, 'easeInQuint', function(e) {
                return event.afterLoad();
              });
            } else {
              setTimeout(event.afterLoad, 500);
            }
          } else {
            logo.hide();
            if (support) {
              $('#single-page div.modal').css({
                marginTop: '15.5px',
                opacity: 1.0
              });
              $('#animation-mask').hide();
              $('footer').parent().show();
            } else {
              $('#single-page div.modal').animate({
                marginTop: '15.5px'
              }, 1000, 'easeOutQuint');
              $('#animation-mask').fadeOut({
                duration: 1000,
                easing: 'easeInQuint'
              });
            }
          }
        } else {
          if (logo.is(':hidden')) {
            logo.fadeIn(1000, 'easeInQuint', function(e) {
              return event.afterLoad();
            });
          } else {
            setTimeout(event.afterLoad, 500);
          }
        }
        return true;
      }
    };
    if (_.waitForLoading === void 0) {
      _.waitForLoading = false;
    }
    if (_.doneLoading === void 0) {
      _.doneLoading = false;
    }
    _.loadingInterval = 60 * 3;
    $meta = $('meta[name=animation]');
    if ($meta.length > 0 && $meta !== void 0) {
      content = $meta[0].getAttribute('content');
      if (content === "fadein") {
        $('#single-page').show();
        $(window).load(function(e) {
          _.doneLoading = true;
          return event.afterLoad();
        });
      }
    }
    pagesViewModel = function() {
      var self;
      self = this;
      self.menu = ko.observable();
      self._page = ko.observable();
      self.page = ko.computed({
        read: function() {
          return this._page();
        },
        write: function(value) {
          var parameter;
          if (self._page() !== value) {
            self._page(value);
            if (value.length > 0) {
              parameter = '';
              if (self.id() !== void 0 && String(self.id()).length > 0) {
                parameter = '/' + self.id();
              }
              History.pushState({
                timestamp: moment().seconds()
              }, _('title.' + self.menu() + '.' + $.camelCase(self._page())), '/' + _.url + '/' + self.menu() + '/' + self._page() + parameter);
            }
          }
          return true;
        },
        owner: self
      });
      self.id = ko.observable('');
      self.username = '';
      self.email = '';
      self.password = '';
      self.signinButton = ko.observable(_('signin'));
      self.applyButton = ko.observable(_('apply.change'));
      self.findPassword = function() {
        if (self.email.length) {
          location.href = _.Users.findPassword(self.email).url;
        } else {
          Messenger().post({
            message: _('form.empty.email'),
            type: 'info'
          });
        }
        return false;
      };
      self.signin = function(elem) {
        self.signinButton(_('signin.progress'));
        _.Users.signin().ajax({
          data: {
            email: self.email,
            password: self.password
          },
          success: function(d, s, x) {
            if (x.status === 202) {
              return location.href = _.Pages.account(d, "").url;
            } else if (x.status === 201) {
              Messenger().post({
                message: _(d),
                type: 'info',
                showCloseButton: true
              });
              return self.signinButton(_('signin'));
            } else {
              Messenger().post({
                message: _(d),
                type: 'error',
                showCloseButton: true
              });
              return self.signinButton(_('signin'));
            }
          },
          error: function(x, s, r) {
            Messenger().post({
              message: _(r),
              type: 'error',
              showCloseButton: true
            });
            return self.signinButton(_('signin'));
          }
        });
        return false;
      };
      self.search = {
        data: ko.observable(),
        dataType: ko.observable(''),
        responseTime: ko.observable('0'),
        itemString: ko.observable('0 item'),
        apikey: ko.observable(''),
        queries: ko.observable(''),
        secretKey: '',
        template: function() {
          if (self.search.dataType() === 'model') {
            return 'model-template';
          } else if (self.search.dataType() === 'status') {
            return 'status-template';
          } else {
            return '';
          }
        },
        refresh: function() {
          return self.search.query(self.search.queries());
        },
        revert: function() {
          self.search.queries('');
          return self.search.data.removeAll();
        },
        afterRender: function() {
          self.search.secretKey = $('#secretKey').html();
          if (self.search.secretKey.length === 0) {
            Messenger().post({
              message: _('secret.key.empty', {
                type: 'error'
              })
            });
          }
          $('input[name=q]').focus();
          return Prism.highlightElement($('#search table pre'), true);
        }
      };
      self.search.query = function(callback) {
        var e, json, parts, temp, url;
        parts = [];
        if (self.search.queries().length) {
          parts = self.search.queries().split(' ');
        }
        switch (parts.length) {
          case 0:
            Messenger().post({
              message: _('query.empty', {
                type: 'error',
                showCloseButton: true
              })
            });
            break;
          case 1:
            self.search.queries(parts[0] + ' {}');
            self.search.query();
            break;
          case 2:
            if (Number(parts[0]).toString() !== 'NaN') {
              Messenger().post({
                message: _('query.sType.invalid', {
                  type: 'error'
                })
              });
              return false;
            }
            json = null;
            try {
              temp = JSON.parse(parts[1]);
              if (toString.call(temp) === '[object Object]') {
                json = temp;
              }
            } catch (_error) {
              e = _error;
            }
            _.responseTime = Date.now();
            self.search.data([]);
            self.search.dataType('model');
            if (json === null) {
              url = _.server + ("/" + parts[0] + "/" + parts[1] + "?apikey=" + self.search.secretKey + "&json=" + (encodeURIComponent(JSON.stringify(json))));
            } else {
              url = _.server + ("/" + parts[0] + "?apikey=" + self.search.secretKey + "&json=" + (encodeURIComponent(JSON.stringify(json))));
            }
            $.ajax({
              url: url,
              type: 'GET',
              async: true,
              cache: false,
              crossDomain: true,
              dataType: 'jsonp',
              jsonpCallback: '_' + Date.now(),
              success: function(d, s, x) {
                var key, len, res, t;
                self.search.responseTime(Date.now() - _.responseTime);
                if (x.status === 200 && d.status !== 404) {
                  res = toString.call(d);
                  if (res === '[object Array]') {
                    len = d.length;
                    self.search.itemString("" + len + " items");
                    for (key in d) {
                      d[key].$type = parts[0];
                    }
                    return self.search.data(d);
                  } else if (res === '[object Object]') {
                    self.search.itemString('1 item');
                    t = Object.keys(d)[0];
                    d[t].$type = parts[0];
                    return self.search.data([d[t]]);
                  } else {
                    return Messenger().post({
                      message: _('query.response.invalid', {
                        type: 'error'
                      })
                    });
                  }
                } else {
                  if (d.status !== void 0) {
                    return self.search.itemString("(" + (_('response.' + d.status)) + ") - 0 item");
                  } else {
                    return self.search.itemString("(" + (_('response.' + x.status)) + ") - 0 item");
                  }
                }
              },
              error: function(x, s, r) {
                self.search.responseTime(Date.now() - _.responseTime);
                return self.search.itemString("(" + (_('response.' + x.status)) + ") - 0 item");
              },
              complete: function() {
                $('input[name=q]').focus();
                return self.prepareComponents();
              }
            });
            break;
          case 3:
            if (!isNaN(Number(parts[0]))) {
              Messenger().post({
                message: _('query.sType.invalid', {
                  type: 'error'
                })
              });
              return false;
            }
            if (!isNaN(Number(parts[1]))) {
              Messenger().post({
                message: _('query.v.invalid', {
                  type: 'error'
                })
              });
              return false;
            }
            if (!isNaN(Number(parts[2]))) {
              Messenger().post({
                message: _('query.oType.invalid', {
                  type: 'error'
                })
              });
              return false;
            }
            _.responseTime = Date.now();
            self.search.data([]);
            self.search.dataType('status');
            url = _.server + ("/" + parts[0] + "/" + parts[1] + "/" + parts[2] + "?apikey=" + self.search.secretKey);
            $.ajax({
              url: url,
              type: 'GET',
              async: true,
              cache: false,
              crossDomain: true,
              dataType: 'jsonp',
              jsonpCallback: '_' + Date.now(),
              success: function(d, s, x) {
                var key, len;
                self.search.responseTime(Date.now() - _.responseTime);
                if (x.status === 200) {
                  len = d.length;
                  if (len > 1) {
                    self.search.itemString("" + len + " items");
                  } else {
                    self.search.itemString("" + len + " item");
                  }
                  for (key in d) {
                    d[key].$subject.$type = parts[0];
                    d[key].$subject.$expanded = ko.observable(false);
                    d[key].$object.$type = parts[2];
                    d[key].$object.$expanded = ko.observable(false);
                  }
                  return self.search.data(d);
                } else {
                  if (d.status !== void 0) {
                    return self.search.itemString("(" + (_('response.' + d.status)) + ") - 0 item");
                  } else {
                    return self.search.itemString("(" + (_('response.' + x.status)) + ") - 0 item");
                  }
                }
              },
              error: function(x, s, r) {
                self.search.responseTime(Date.now() - _.responseTime);
                return self.search.itemString("(" + (_('response.' + x.status)) + ") - 0 item");
              },
              complete: function() {
                $('input[name=q]').focus();
                return self.prepareComponents();
              }
            });
            break;
          case 4:
            if (!isNaN(Number(parts[0]))) {
              Messenger().post({
                message: _('query.sType.invalid', {
                  type: 'error'
                })
              });
              return false;
            } else {
              temp = Number(parts[1]);
              if (!isNaN(temp && isFinite(temp))) {
                if (!isNaN(Number(parts[2]))) {
                  temp = Number(parts[3]);
                  if (!isNaN(temp)) {
                    Messenger().post({
                      message: _('query.oType.invalid', {
                        type: 'error'
                      })
                    });
                    return false;
                  }
                }
              } else {
                if (!isNaN(Number(parts[2]))) {
                  Messenger().post({
                    message: _('query.v.invalid', {
                      type: 'error'
                    })
                  });
                  return false;
                } else {
                  temp = Number(parts[3]);
                  if ((!isNaN(temp && isFinite(temp))) === false) {
                    Messenger().post({
                      message: _('query.oNo.invalid', {
                        type: 'error'
                      })
                    });
                    return false;
                  }
                }
              }
            }
            _.responseTime = Date.now();
            self.search.data([]);
            self.search.dataType('status');
            url = _.server + ("/" + parts[0] + "/" + parts[1] + "/" + parts[2] + "/" + parts[3] + "?apikey=" + self.search.secretKey);
            $.ajax({
              url: url,
              type: 'GET',
              async: true,
              cache: false,
              crossDomain: true,
              dataType: 'jsonp',
              jsonpCallback: '_' + Date.now(),
              success: function(d, s, x) {
                var key, len;
                self.search.responseTime(Date.now() - _.responseTime);
                if (x.status === 200) {
                  len = d.length;
                  if (len > 1) {
                    self.search.itemString("" + len + " items");
                  } else {
                    self.search.itemString("" + len + " item");
                  }
                  for (key in d) {
                    d[key].$subject.$type = parts[0];
                    d[key].$subject.$expanded = ko.observable(false);
                    d[key].$object.$type = parts[2];
                    d[key].$object.$expanded = ko.observable(false);
                  }
                  return self.search.data(d);
                } else {
                  if (d.status !== void 0) {
                    return self.search.itemString("(" + (_('response.' + d.status)) + ") - 0 item");
                  } else {
                    return self.search.itemString("(" + (_('response.' + x.status)) + ") - 0 item");
                  }
                }
              },
              error: function(x, s, r) {
                self.search.responseTime(Date.now() - _.responseTime);
                return self.search.itemString("(" + (_('response.' + x.status)) + ") - 0 item");
              },
              complete: function() {
                $('input[name=q]').focus();
                return self.prepareComponents();
              }
            });
            break;
          case 5:
            if (!isNaN(Number(parts[0]))) {
              Messenger().post({
                message: _('query.sType.invalid', {
                  type: 'error'
                })
              });
              return false;
            }
            if (!isNaN(Number(parts[2]))) {
              Messenger().post({
                message: _('query.v.invalid', {
                  type: 'error'
                })
              });
              return false;
            }
            if (!isNaN(Number(parts[3]))) {
              Messenger().post({
                message: _('query.oType.invalid', {
                  type: 'error'
                })
              });
              return false;
            }
            _.responseTime = Date.now();
            self.search.data([]);
            self.search.dataType('status');
            url = _.server + ("/" + parts[0] + "/" + parts[1] + "/" + parts[2] + "/" + parts[3] + "/" + parts[4] + "?apikey=" + self.search.secretKey);
            $.ajax({
              url: url,
              type: 'GET',
              async: true,
              cache: false,
              crossDomain: true,
              dataType: 'jsonp',
              jsonpCallback: '_' + Date.now(),
              success: function(d, s, x) {
                var key, len;
                self.search.responseTime(Date.now() - _.responseTime);
                if (x.status === 200) {
                  len = d.length;
                  if (len > 1) {
                    self.search.itemString("" + len + " items");
                  } else {
                    self.search.itemString("" + len + " item");
                  }
                  for (key in d) {
                    d[key].$subject.$type = parts[0];
                    d[key].$subject.$expanded = ko.observable(false);
                    d[key].$object.$type = parts[2];
                    d[key].$object.$expanded = ko.observable(false);
                  }
                  return self.search.data(d);
                } else {
                  if (d.status !== void 0) {
                    return self.search.itemString("(" + (_('response.' + d.status)) + ") - 0 item");
                  } else {
                    return self.search.itemString("(" + (_('response.' + x.status)) + ") - 0 item");
                  }
                }
              },
              error: function(x, s, r) {
                self.search.responseTime(Date.now() - _.responseTime);
                return self.search.itemString("(" + (_('response.' + x.status)) + ") - 0 item");
              },
              complete: function() {
                $('input[name=q]').focus();
                return self.prepareComponents();
              }
            });
            break;
          default:
            Messenger().post({
              message: _('query.invalid.long', {
                type: 'error'
              })
            });
        }
        return false;
      };
      self.apiKey = {
        data: ko.observableArray(),
        create: function() {
          return self.apiKey.data.unshift({
            $id: ko.observable(''),
            $no: ko.observable(0),
            label: ko.observable('test'),
            $createdAt: 0,
            $updatedAt: 0,
            url: ko.observableArray([
              {
                value: ko.observable('*')
              }
            ]),
            logThreshold: ko.observable('warn'),
            scope: ko.observableArray([
              {
                name: "read_model",
                value: true
              }, {
                name: "create_model",
                value: true
              }, {
                name: "update_model",
                value: true
              }, {
                name: "search_status",
                value: true
              }, {
                name: "create_status",
                value: true
              }, {
                name: "delete_status",
                value: false
              }, {
                name: "manage_order",
                value: false
              }, {
                name: "manage_pickup",
                value: false
              }
            ])
          });
        },
        addUrl: function(key) {
          return key.url.push({
            value: ''
          });
        },
        removeUrl: function() {
          var key, value;
          key = arguments[0];
          value = arguments[1];
          return key.url.remove(value);
        },
        save: function(key) {
          _.Pages.accountApiKeyUpdate(_.url).ajax({
            contentType: 'application/json',
            data: ko.toJSON(key),
            success: function(d, s, x) {
              if (x.status !== 201) {
                return Messenger().post({
                  message: _(d),
                  type: 'error',
                  showCloseButton: true
                });
              } else {
                return Messenger().post({
                  message: _(d),
                  type: 'success',
                  showCloseButton: true,
                  actions: {
                    reload: {
                      label: 'Refresh now',
                      action: function() {
                        return location.reload();
                      }
                    }
                  }
                });
              }
            },
            error: function(x, s, r) {
              var msg;
              return msg = Messenger().post({
                message: r,
                type: 'error',
                showCloseButton: true,
                actions: {
                  retry: {
                    label: 'Retry Now',
                    action: function() {
                      return self.apiKey.save(key);
                    }
                  }
                }
              });
            }
          });
          return false;
        },
        "delete": function(key) {
          if (confirm(_('confirm.delete')) === false) {
            return false;
          }
          if (key.$no() > 0) {
            return _.Pages.accountApiKeyDelete(_.url, key.$no()).ajax({
              success: function(d, s, x) {
                if (x.status !== 201) {
                  return Messenger().post({
                    message: _(d),
                    type: 'error',
                    showCloseButton: true
                  });
                } else {
                  self.apiKey.data.remove(key);
                  return Messenger().post({
                    message: _(d),
                    type: 'success',
                    showCloseButton: true,
                    actions: {
                      reload: {
                        label: 'Refresh now',
                        action: function() {
                          location.hash = _.currentSave;
                          return location.reload();
                        }
                      }
                    }
                  });
                }
              },
              error: function(x, s, r) {
                var msg;
                return msg = Messenger().post({
                  message: r,
                  type: 'error',
                  showCloseButton: true,
                  actions: {
                    retry: {
                      label: 'Retry Now',
                      action: function() {
                        return self.apiKey["delete"](key);
                      }
                    }
                  }
                });
              }
            });
          } else {
            return Messenger().post({
              message: _('delete.fail'),
              type: 'error',
              showCloseButton: true
            });
          }
        },
        load: function(data) {
          return ko.mapping.fromJS(data, {}, self.apiKey.data);
        }
      };
      self.orderStatus = {
        data: ko.observableArray(),
        create: function() {
          return true;
        },
        start: function(item) {
          _.Pages.orderStatusStart(_.url, item.$no()).ajax({
            success: function(d, s, x) {
              if (x.status === 202) {
                return item.state('running');
              } else {
                return Messenger().post({
                  message: _('order.start.fail'),
                  type: 'error'
                });
              }
            },
            error: function() {
              return Messenger().post({
                message: _('order.start.fail'),
                type: 'error'
              });
            }
          });
          return true;
        },
        pause: function(item) {
          if (!confirm(_('confirm.order.pause'))) {
            return false;
          }
          _.Pages.orderStatusPause(_.url, item.$no()).ajax({
            success: function(d, s, x) {
              if (x.status === 202) {
                return item.state('paused');
              } else {
                return Messenger().post({
                  message: _('order.pause.fail'),
                  type: 'error'
                });
              }
            },
            error: function() {
              return Messenger().post({
                message: _('order.pause.fail'),
                type: 'error'
              });
            }
          });
          return true;
        },
        "delete": function(item) {
          if (!confirm(_('confirm.order.delete'))) {
            return false;
          }
          self.orderStatus.data.remove(item);
          return _.Pages.orderDelete(_.url, item.$no()).ajax();
        },
        afterRender: function() {
          return self.prepareComponents();
        }
      };
      self.orderAdd = {
        source: [],
        verbs: ko.observableArray(),
        types: ko.observableArray(),
        basicQuery: ko.observable(),
        advancedQuery: ko.observable("{\n  \"dataType\": \"\",\n  \"dataQuery\": \"\",\n  \"plans\": [\n    {\n      \"key\": \"\",\n      \"value\": \"\"\n    }\n  ],\n  \"duration\": \"5 minutes\",\n  \"title\": \"\",\n  \"state\": \"paused\"\n}"),
        mode: ko.observable('basic'),
        data: {
          dataType: ko.observable(''),
          dataQuery: ko.observable(''),
          plans: ko.observableArray([]),
          duration: ko.observable('5 minutes'),
          title: ko.observable(''),
          state: ko.observable('paused')
        },
        secretKey: '',
        create: function() {
          var data, e, json, q, request;
          data = self.orderAdd;
          request = data.data;
          json = null;
          if (data.mode() === 'basic') {
            q = data.basicQuery();
            if (data.source.indexOf(q) === -1) {
              Messenger().post({
                message: _('form.basicQuery.invalid'),
                type: 'info'
              });
              return false;
            } else if (q[q.length - 1] === ' ') {
              Messenger().post({
                message: _('form.basicQuery.incomplete'),
                type: 'info'
              });
              return false;
            }
            q = q.split(' ');
            switch (q.length) {
              case 4:
                request.dataType('model');
                request.dataQuery(q[3]);
                request.plans.removeAll();
                request.plans.push({
                  key: 'count',
                  value: ''
                });
                break;
              case 8:
                request.dataType('status');
                request.dataQuery(q[3] + ' ' + q[6] + ' ' + q[8]);
                request.plans.removeAll();
                request.plans.push({
                  key: 'count',
                  value: 's'
                });
                break;
              case 10:
                request.dataType('status');
                request.dataQuery(q[6] + ' ' + q[7] + ' ' + q[9]);
                request.plans.removeAll();
                request.plans.push({
                  key: 'count',
                  value: ''
                });
                break;
              case 11:
                request.dataType('status');
                request.dataQuery(q[6] + ' ' + q[7] + ' ' + q[10]);
                request.plans.removeAll();
                request.plans.push({
                  key: 'count',
                  value: 'o'
                });
                break;
              default:
                Messenger().post({
                  message: _('form.basicQuery.incomplete'),
                  type: 'info'
                });
                return false;
            }
            json = JSON.parse(ko.toJSON(request));
          } else if (data.mode() === 'advanced') {
            try {
              json = JSON.parse(data.advancedQuery());
            } catch (_error) {
              e = _error;
              Messenger().post({
                message: _('form.advancedQuery.invalid'),
                type: 'error'
              });
              return false;
            }
          } else {
            Messenger().post({
              message: _('form.empty'),
              type: 'error'
            });
            return false;
          }
          if (!json.dataType.length) {
            Messenger().post({
              message: _('form.dataType.empty'),
              type: 'error'
            });
            return false;
          }
          if (!json.dataQuery.length) {
            Messenger().post({
              message: _('form.dataQuery.empty'),
              type: 'error'
            });
            return false;
          }
          if (!json.state.length) {
            Messenger().post({
              message: _('form.order.state.empty'),
              type: 'error'
            });
            return false;
          }
          if (!json.title.length) {
            Messenger().post({
              message: _('form.order.title.empty'),
              type: 'error'
            });
            return false;
          }
          _.Pages.orderAddUpdate(_.url).ajax({
            contentType: 'application/json',
            data: JSON.stringify(json),
            success: function(d, s, x) {
              console.log(d, s);
              if (x.status === 201) {
                Messenger().post({
                  message: _(d),
                  type: 'success'
                });
                return location.href = _.Pages.order(_.url, '/status').url;
              } else {
                return Messenger().post({
                  message: _(d),
                  type: 'error'
                });
              }
            },
            error: function(x, s, r) {
              console.log(r, s);
              return Messenger().post({
                message: _('error.' + x.status),
                type: 'error'
              });
            }
          });
          return false;
        },
        optionsAfterRender: function(element, index, data) {},
        afterRender: function() {
          var q;
          $('select').selectpicker();
          $('#basicQuery').focus();
          self.orderAdd.secretKey = $('#secretKey').html();
          self.search.secretKey = $('#secretKey').html();
          if (self.orderAdd.secretKey.length === 0) {
            Messenger().post({
              message: _('secret.key.empty', {
                type: 'error'
              })
            });
          }
          q = $('#basicQuery');
          return q.typeahead({
            source: self.orderAdd.source,
            items: 10,
            minLength: 0,
            matcher: function(item) {
              var p1, p2;
              p1 = item.split(' ').length;
              p2 = this.query.split(' ').length;
              if (item.toUpperCase().startsWith(this.query.toUpperCase()) && Math.max(p1 - 2, 0) <= p2) {
                return true;
              } else {
                return false;
              }
            }
          });
        }
      };
      self.pickupStatus = {
        data: ko.observable(),
        afterRender: function() {
          return self.prepareComponents();
        }
      };
      self.usage = {
        data: ko.observable()
      };
      self.plansAndBilling = {
        data: ko.observable()
      };
      self.prepareComponents = function() {
        $('time').each(function(k, v) {
          var $this, m;
          $this = $(v);
          if ($this.is('[ago]')) {
            m = moment(Number($this.html()));
            $this.html(m.fromNow());
            $this.attr('datetime', m.format());
            $this.attr('title', m.format());
            return $this.tooltip({
              placement: 'bottom'
            });
          } else {
            m = moment(Number($this.html()));
            return $this.html(m.format());
          }
        });
        $('input[type=file]').bootstrapFileInput();
        $('select').selectpicker();
        return true;
      };
      self.applyUrl = function() {
        var parts;
        parts = location.pathname.split('/');
        if (parts.length > 2) {
          self.menu(parts[2]);
        }
        if (parts.length > 3) {
          if (parts[4] !== void 0) {
            self.id(parts[4]);
          }
          return self.page(parts[3]);
        } else {
          self._page('');
          return false;
        }
      };
      self.applyUrl();
      self.showMessage = function() {
        var _ref, _ref1;
        if ((_ref = _.error) != null ? _ref.length : void 0) {
          Messenger().post({
            message: _(_.error),
            type: 'error',
            showCloseButton: true
          });
        }
        if ((_ref1 = _.success) != null ? _ref1.length : void 0) {
          return Messenger().post({
            message: _(_.success),
            type: 'success'
          });
        }
      };
      History.Adapter.bind(window, 'statechange', function(e) {
        var route, state;
        state = History.getState();
        if (state.data.timestamp !== moment().seconds()) {
          if (self.applyUrl() === false) {
            return false;
          }
        }
        route = $.camelCase(self.menu() + '-' + self.page());
        if (route in _.Pages) {
          _.Pages[route](_.url).ajax({
            success: function(d, s, x) {
              var key;
              if (x.status !== 200) {
                return Messenger().post({
                  message: _(d),
                  type: 'error',
                  showCloseButton: true
                });
              } else {
                switch (self.page()) {
                  case 'api-key':
                    return self.apiKey.load(d);
                  case 'import':
                    return self.showMessage();
                  case 'status':
                    if (self.menu() === 'order') {
                      for (key in d) {
                        d[key].$expanded = false;
                      }
                      return ko.mapping.fromJS(d, {}, self.orderStatus.data);
                    } else {
                      return self.pickupStatus.data(d);
                    }
                    break;
                  case 'add':
                    if (self.menu() === 'order') {
                      $.when(_.Pages.orderAddVerb(_.url).ajax(), _.Pages.orderAddType(_.url).ajax()).done(function(verbs, types) {
                        var a, b, v, _i, _j, _len, _len1, _ref, _ref1, _results;
                        self.orderAdd.types(types[0]);
                        self.orderAdd.verbs(verbs[0]);
                        self.orderAdd.source.push('Count ');
                        self.orderAdd.source.push('Count how ');
                        self.orderAdd.source.push('Count how many ');
                        self.orderAdd.source.push('Count how many times ');
                        self.orderAdd.source.push('Count how many times does');
                        self.orderAdd.source.push('Count how many times does a ');
                        _ref = self.orderAdd.types();
                        _results = [];
                        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                          a = _ref[_i];
                          self.orderAdd.source.push("Count how many " + a.name);
                          self.orderAdd.source.push("Count how many times does a " + a.name);
                          self.orderAdd.source.push("Count how many " + a.name + " did ");
                          _ref1 = self.orderAdd.verbs();
                          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
                            v = _ref1[_j];
                            self.orderAdd.source.push("Count how many " + a.name + " did " + v.verb + " ");
                            self.orderAdd.source.push("Count how many " + a.name + " did " + v.verb + " some ");
                            self.orderAdd.source.push("Count how many times does a " + a.name + " " + v.verb);
                            self.orderAdd.source.push("Count how many times does a " + a.name + " " + v.verb + " some ");
                            self.orderAdd.source.push("Count how many times does a " + a.name + " " + v.verb + " for each ");
                          }
                          _results.push((function() {
                            var _k, _len2, _ref2, _results1;
                            _ref2 = self.orderAdd.types();
                            _results1 = [];
                            for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
                              b = _ref2[_k];
                              _results1.push((function() {
                                var _l, _len3, _ref3, _results2;
                                _ref3 = self.orderAdd.verbs();
                                _results2 = [];
                                for (_l = 0, _len3 = _ref3.length; _l < _len3; _l++) {
                                  v = _ref3[_l];
                                  self.orderAdd.source.push("Count how many " + a.name + " did " + v.verb + " some " + b.name);
                                  self.orderAdd.source.push("Count how many times does a " + a.name + " " + v.verb + " some " + b.name);
                                  _results2.push(self.orderAdd.source.push("Count how many times does a " + a.name + " " + v.verb + " for each " + b.name));
                                }
                                return _results2;
                              })());
                            }
                            return _results1;
                          })());
                        }
                        return _results;
                      });
                    } else {

                    }
                    return true;
                  case 'export':
                    break;
                  default:
                    return self[$.camelCase(self.page())].data(d);
                }
              }
            },
            error: function(x, s, r) {
              var msg;
              return msg = Messenger().post({
                message: r,
                type: 'error',
                showCloseButton: true,
                actions: {
                  retry: {
                    label: 'Retry Now',
                    action: function() {
                      return location.reload();
                    }
                  }
                }
              });
            }
          });
        } else {
          Messenger().post({
            message: _('page.empty'),
            type: 'error',
            showCloseButton: true
          });
        }
        return true;
      });
      $(window).trigger('statechange');
      return true;
    };
    ko.applyBindings(new pagesViewModel());
    return true;
  });

}).call(this);
